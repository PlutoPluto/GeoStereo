<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>赤平投影绘制</title>
    <style>
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f4f4f9;
            padding: 30px;
            margin: 0;
            color: #333;
        }

        .main-layout {
            display: flex;
            gap: 30px;
            align-items: flex-start;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 1100px;
            width: 100%;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
        }

        .input-section { flex: 1; min-width: 300px; }
        .canvas-section { align-items: center; }

        h2 { margin-top: 0; color: #444; font-size: 1.2rem; border-bottom: 2px solid #eee; padding-bottom: 10px;}

        /* 输入区样式 */
        textarea {
            width: 100%;
            height: 380px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', monospace; 
            font-size: 14px;
            resize: vertical;
            box-sizing: border-box;
            background-color: #fafafa;
            outline: none;
        }
        textarea:focus { border-color: #2196F3; background-color: #fff; }

        .helper-text {
            font-size: 0.9em;
            color: #555;
            margin-bottom: 15px;
            background: #e3f2fd;
            padding: 12px;
            border-radius: 6px;
            border-left: 5px solid #2196F3;
            line-height: 1.6;
        }
        
        code { background: rgba(255,255,255,0.7); padding: 2px 4px; border-radius: 3px; font-weight: bold; color: #d32f2f; }

        .buttons { margin-top: 20px; display: flex; gap: 15px; }
        button {
            flex: 1; padding: 12px; border: none; border-radius: 6px;
            cursor: pointer; font-weight: 600; color: white;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }
        #plotBtn { background: linear-gradient(135deg, #2196F3, #1976D2); }
        #clearBtn { background: linear-gradient(135deg, #ff5252, #d32f2f); }

        canvas { border: 1px solid #eee; cursor: crosshair; }
    </style>
</head>
<body>

    <div class="main-layout">
        
        <!-- 左侧：输入区域 -->
        <div class="card input-section">
            <h2>数据录入</h2>
            
            <div class="helper-text">
                <strong>格式说明：</strong><br>
                <code>标签名称 倾向 倾角</code> (空格分隔)<br><br>
                <strong>示例：</strong><br>
                J1 135 45<br>
                J2 210 60<br>
                结构面A 090 30<br>
                045 15 (无标签模式)
            </div>

            <textarea id="dataInput" placeholder="J1 135 45
J2 210 60
边坡 090 30"></textarea>

            <div class="buttons">
                <button id="plotBtn">生成赤平图</button>
                <button id="clearBtn">清空</button>
            </div>
        </div>

        <!-- 右侧：绘图区域 -->
        <div class="card canvas-section">
            <canvas id="stereoCanvas" width="600" height="600"></canvas>
            <div style="margin-top:10px; color:#888; font-size:12px;">Wulff Net (等角投影) - 每10度一刻度</div>
        </div>

    </div>

    <script>
        const canvas = document.getElementById('stereoCanvas');
        const ctx = canvas.getContext('2d');
        
        // 高清屏适配
        const dpr = window.devicePixelRatio || 1;
        const size = 600;
        canvas.width = size * dpr;
        canvas.height = size * dpr;
        canvas.style.width = size + "px";
        canvas.style.height = size + "px";
        ctx.scale(dpr, dpr);

        const centerX = size / 2;
        const centerY = size / 2;
        const radius = (size / 2) - 40; // 留出边缘写字

        const rad = deg => deg * Math.PI / 180;
        const deg = r => r * 180 / Math.PI;

        function drawGrid() {
            ctx.clearRect(0, 0, size, size);
            
            // 1. 绘制外圆
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#333';
            ctx.stroke();

            // 2. 绘制刻度线 (每10度)
            ctx.strokeStyle = '#333';
            ctx.fillStyle = '#000';
            ctx.font = '10px Arial'; // 小刻度数字字体

            for (let i = 0; i < 360; i += 10) {
                // 计算角度 (注意：Canvas 0度是右边，地理0度是上边)
                // 地理角度 i -> Canvas 角度 angle
                const angle = rad(i - 90);

                // 判断刻度长度：90度倍数长一点，10度倍数短一点
                const isMajor = (i % 90 === 0);
                const tickLen = isMajor ? 10 : 5;
                
                // 外点 (圆上)
                const xOut = centerX + radius * Math.cos(angle);
                const yOut = centerY + radius * Math.sin(angle);
                
                // 内点
                const xIn = centerX + (radius - tickLen) * Math.cos(angle);
                const yIn = centerY + (radius - tickLen) * Math.sin(angle);

                // 绘制刻度线
                ctx.beginPath();
                ctx.moveTo(xIn, yIn);
                ctx.lineTo(xOut, yOut);
                ctx.lineWidth = isMajor ? 2 : 1;
                ctx.stroke();
            }

            // 3. 标记 N E S W (大字)
            ctx.font = 'bold 18px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            const textOffset = 25; // 文字距离圆心的额外距离

            ctx.fillText('N', centerX, centerY - radius - textOffset);
            ctx.fillText('S', centerX, centerY + radius + textOffset);
            ctx.fillText('E', centerX + radius + textOffset, centerY);
            ctx.fillText('W', centerX - radius - textOffset, centerY);

            // 4. 绘制中心十字丝
            ctx.beginPath();
            ctx.moveTo(centerX, centerY - 6); ctx.lineTo(centerX, centerY + 6);
            ctx.moveTo(centerX - 6, centerY); ctx.lineTo(centerX + 6, centerY);
            ctx.lineWidth = 1;
            ctx.strokeStyle = '#666';
            ctx.stroke();
        }

        // 投影计算
        function projectPoint(trend, plunge) {
            const r = radius * Math.tan(rad(90 - plunge) / 2);
            const theta = rad(trend - 90);
            const x = centerX + r * Math.cos(theta);
            const y = centerY + r * Math.sin(theta);
            return { x, y };
        }

        // 绘制大圆
        function drawGreatCircle(label, dipDirection, dip) {
            dip = Math.max(0, Math.min(90, dip));
            let strike = dipDirection - 90;

            // 绘制弧线
            ctx.beginPath();
            let first = true;
            for (let alpha = 0; alpha <= 180; alpha += 2) {
                const appDipRad = Math.atan(Math.tan(rad(dip)) * Math.sin(rad(alpha)));
                const appDip = deg(appDipRad);
                const p = projectPoint(strike + alpha, appDip);
                if (first) { ctx.moveTo(p.x, p.y); first = false; }
                else { ctx.lineTo(p.x, p.y); }
            }
            ctx.strokeStyle = 'rgba(33, 150, 243, 0.8)';
            ctx.lineWidth = 2;
            ctx.stroke();

            // 绘制标签
            if (label) {
                // 标签放在大圆的最深处（真倾角位置）
                const labelPos = projectPoint(dipDirection, dip);
                
                ctx.font = "bold 14px Microsoft YaHei";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                
                // 白色描边 (Halo)
                ctx.lineWidth = 4;
                ctx.strokeStyle = "white";
                ctx.strokeText(label, labelPos.x, labelPos.y);
                
                // 红色文字
                ctx.fillStyle = "#D32F2F";
                ctx.fillText(label, labelPos.x, labelPos.y);
            }
        }

        // 按钮事件
        document.getElementById('plotBtn').addEventListener('click', () => {
            drawGrid();
            const text = document.getElementById('dataInput').value;
            const lines = text.split('\n');

            lines.forEach(line => {
                const parts = line.trim().split(/\s+/);
                if (parts.length >= 2) {
                    const dipRaw = parts.pop(); 
                    const dirRaw = parts.pop(); 
                    const dip = parseFloat(dipRaw);
                    const dir = parseFloat(dirRaw);
                    let label = parts.join(" "); 

                    if (!isNaN(dir) && !isNaN(dip)) {
                        drawGreatCircle(label, dir, dip);
                    }
                }
            });
        });

        document.getElementById('clearBtn').addEventListener('click', () => {
            document.getElementById('dataInput').value = "";
            drawGrid();
        });

        // 初始化
        drawGrid();
    </script>
</body>
</html>
